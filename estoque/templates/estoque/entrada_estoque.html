{% extends 'estoque/base.html' %}

{% block title %}Entrada de Estoque{% endblock %}

{% block content %}
<h1>Entrada de Estoque</h1>
<form method="post" id="estoqueForm">
    {% csrf_token %}
    {{ form.as_p }}
    <h4>Medicamentos</h4>
    <table class="table table-bordered" id="medicamentos-table">
        <thead>
            <tr>
                <th>Medicamento</th>
                <th>Quantidade</th>
                <th>Validade</th>
                <th>Localização</th>
                <th>Fabricante</th>
                <th>Valor</th>
            </tr>
        </thead>
        <tbody>
            {% for form in formset %}
            <tr class="form-row align-items-center">
                <td class="col-md-2">{{ form.medicamento }}</td>
                <td class="col-md-1">{{ form.quantidade }}</td>
                <td class="col-md-2">{{ form.validade }}</td>
                <td class="col-md-2">{{ form.localizacao }}</td>
                <td class="col-md-2">{{ form.fabricante }}</td>
                <td class="col-md-1">{{ form.valor }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <button type="button" class="btn btn-secondary" id="add-medicamento">Adicionar Medicamento</button>
    <button type="submit" class="btn btn-primary">Salvar</button>
</form>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const formsetPrefix = '{{ formset.prefix }}';
        const totalFormsInput = document.querySelector(`#id_${formsetPrefix}-TOTAL_FORMS`);
        const tableBody = document.querySelector('#medicamentos-table tbody');
        const addMedicamentoButton = document.getElementById('add-medicamento');

        addMedicamentoButton.addEventListener('click', function() {
            const formCount = parseInt(totalFormsInput.value);

            const newFormHtml = `
                <tr class="form-row align-items-center">
                    <td class="col-md-2">
                        <select name="${formsetPrefix}-${formCount}-medicamento" class="form-control" id="id_${formsetPrefix}-${formCount}-medicamento">
                            {% for medicamento in medicamentos_disponiveis %}
                                <option value="{{ medicamento.id }}">{{ medicamento.nome }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td class="col-md-1">
                        <input type="number" name="${formsetPrefix}-${formCount}-quantidade" class="form-control" id="id_${formsetPrefix}-${formCount}-quantidade">
                    </td>
                    <td class="col-md-2">
                        <input type="text" name="${formsetPrefix}-${formCount}-validade" class="form-control" id="id_${formsetPrefix}-${formCount}-validade">
                    </td>
                    <td class="col-md-2">
                        <select name="${formsetPrefix}-${formCount}-localizacao" class="form-control" id="id_${formsetPrefix}-${formCount}-localizacao">
                            {% for localizacao in localizacoes_disponiveis %}
                                <option value="{{ localizacao.id }}">{{ localizacao.nome }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td class="col-md-2">
                        <select name="${formsetPrefix}-${formCount}-fabricante" class="form-control" id="id_${formsetPrefix}-${formCount}-fabricante">
                            {% for fabricante in fabricantes_disponiveis %}
                                <option value="{{ fabricante.id }}">{{ fabricante.nome }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td class="col-md-1">
                        <input type="text" name="${formsetPrefix}-${formCount}-valor" class="form-control currency-input" id="id_${formsetPrefix}-${formCount}-valor">
                    </td>
                </tr>`;

            tableBody.insertAdjacentHTML('beforeend', newFormHtml);
            totalFormsInput.value = formCount + 1;
        });
    });
</script>

{% endblock %}