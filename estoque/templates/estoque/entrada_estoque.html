{% extends 'estoque/base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<h2>Entrada de Estoque de Medicamentos</h2>

<form method="POST" enctype="multipart/form-data">
    {% csrf_token %}

    <h3>Informações da Entrada</h3>
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label for="id_tipo">Tipo de Entrada</label>
                {{ entrada_form.tipo|crispy }}
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label for="id_data">Data Nota Fiscal</label>
                {{ entrada_form.data|crispy }}
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label for="id_fonte_financiamento">Fonte de Financiamento</label>
                {{ entrada_form.fonte_financiamento|crispy }}
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label for="id_fornecedor">Fornecedor</label>
                {{ entrada_form.fornecedor|crispy }}
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label for="id_numero_documento">Número do Documento</label>
                {{ entrada_form.numero_documento|crispy }}
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label for="id_valor_total">Valor Total</label>
                {{ entrada_form.valor_total|crispy }}
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="form-group">
                <label for="id_observacao">Observação</label>
                {{ entrada_form.observacao|crispy }}
            </div>
        </div>
    </div>

    <h3>Detalhes dos Medicamentos</h3>
    <div id="detalhes-formset">
        {{ detalhes_formset.management_form }}
        {% for form in detalhes_formset %}
            <div class="form-row">
                <div class="col-md-4">
                    {{ form.medication|crispy }}
                </div>
                <div class="col-md-4">
                    {{ form.quantidade|crispy }}
                </div>
                <div class="col-md-4">
                    {{ form.lote|crispy }}
                </div>
                <div class="col-md-4">
                    {{ form.validade|crispy }}
                </div>
                <div class="col-md-4">
                    {{ form.localizacao|crispy }}
                </div>
                <div class="col-md-4">
                    {{ form.fabricante|crispy }}
                </div>
            </div>
        {% endfor %}
    </div>
    
    <button type="button" id="adicionar-medicamento" class="btn btn-success mt-4">Adicionar Medicamento</button>
    <button type="submit" class="btn btn-primary mt-4">Salvar</button>
</form>

    <button type="button" id="adicionar-medicamento" class="btn btn-success mt-4">Adicionar Medicamento</button>
    <button type="submit" class="btn btn-primary mt-4">Salvar</button>
</form>

<script>
    document.addEventListener('DOMContentLoaded', function () {
    const formset = document.getElementById('detalhes-formset');
    const addButton = document.getElementById('adicionar-medicamento');

    addButton.addEventListener('click', function () {
        const totalForms = document.querySelector('[name="form-TOTAL_FORMS"]');
        const formCount = parseInt(totalForms.value);

        // Pegando o último formulário como base
        const lastForm = formset.querySelector('.form-row:last-of-type');
        if (!lastForm) return; // Evita erro se não houver formulário inicial

        const newForm = lastForm.cloneNode(true);

        // Atualizando os índices dos campos clonados
        const fields = newForm.querySelectorAll('input, select, textarea');
        fields.forEach(field => {
            if (field.name) {
                field.name = field.name.replace(/\d+/, formCount);
                field.id = field.id.replace(/\d+/, formCount);
            }

            // Resetando os valores
            if (field.tagName === "SELECT") {
                field.selectedIndex = 0; // Limpa a seleção do select
            } else if (field.type !== "hidden") {
                field.value = ""; // Limpa os inputs
            }
        });

        // Adicionando o novo formulário ao formset
        formset.appendChild(newForm);
        totalForms.value = formCount + 1; // Atualiza a contagem do formset
    });
});

</script>

{% endblock %}
