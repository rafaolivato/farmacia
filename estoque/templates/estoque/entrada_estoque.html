{% extends 'estoque/base.html' %}

{% block title %}Entrada de Estoque{% endblock %}

{% block content %}
    <h1>Entrada de Estoque</h1>

    {% if messages %}
        <ul class="messages">
            {% for message in messages %}
                <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        {{ formset.management_form }}
        <div id="formset-container">
            {% for form_detalhe in formset %}
                {{ form_detalhe.as_p }}
            {% endfor %}
        </div>
        <button type="button" id="adicionar-medicamento">Adicionar Medicamento</button>
        <button type="submit">Salvar</button>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const adicionarMedicamentoBtn = document.getElementById('adicionar-medicamento');
            const formsetContainer = document.getElementById('formset-container');
            const totalForms = document.getElementById('id_form-TOTAL_FORMS');
            const formPrefix = 'form';

            adicionarMedicamentoBtn.addEventListener('click', function() {
                if (!totalForms) {
                    console.error('Elemento id_form-TOTAL_FORMS não encontrado.');
                    return;
                }
                
                const formCount = parseInt(totalForms.value);
                const newForm = document.querySelectorAll(`[id^=${formPrefix}-__prefix__]`);
                console.log(newForm); // Adicione esta linha para depuração
                if (newForm.length === 0) {
                    console.error('Nenhum elemento encontrado com o prefixo form-__prefix__.');
                    return;
                }
                const clonedForm = newForm[0].cloneNode(true);

                clonedForm.innerHTML = clonedForm.innerHTML.replace(/__prefix__/g, formCount);
                formsetContainer.appendChild(clonedForm);

                totalForms.value = formCount + 1;
            });
        });
    </script>
{% endblock %}