{% extends 'estoque/base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<h2>Distribuição de Medicamentos</h2>
<p>Distribua medicamentos do estabelecimento {{ user.profile.estabelecimento.nome }} para outro estabelecimento.</p>

<form method="POST">
    {% csrf_token %}
    {{ form|crispy }}

    <button type="submit" class="btn btn-primary mt-3">Confirmar Distribuição</button>
</form>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const medicamentoField = document.getElementById('id_medicamento');
        const loteField = document.getElementById('id_lote');

        medicamentoField.addEventListener('change', () => {
            const medicamentoId = medicamentoField.value;

            if (medicamentoId) {
                fetch(`/api/lotes_por_medicamento/${medicamentoId}/`)
                    .then(response => response.json())
                    .then(data => {
                        loteField.innerHTML = ''; // Limpa opções anteriores
                        data.forEach(lote => {
                            const option = document.createElement('option');
                            option.value = lote.id;
                            option.textContent = `${lote.codigo} (Quantidade: ${lote.quantidade})`;
                            loteField.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Erro ao buscar lotes:', error));
            } else {
                loteField.innerHTML = ''; // Limpa se nada for selecionado
            }
        });
    });
</script>
{% endblock %}
