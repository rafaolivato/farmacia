{% extends 'estoque/base.html' %}

{% block content %}
<div class="container mt-5">
    <div class="card shadow-lg">
        <div class="card-header bg-primary text-white text-center">
            <h2 class="logincolor">Saída de Estoque</h2>
        </div>
        <div class="card-body">
            <!-- Formulário para a saída de estoque -->
            <form method="POST" id="saida-estoque-form">
                {% csrf_token %}
                {{ form.as_p }}
                <!-- Botão para confirmar a retirada -->
                <button type="submit" class="btn btn-primary mt-4">Confirmar Retirada</button>
                <button type="submit" class="btn btn-success">Adicionar Medicamentos</button>
            </form>
        </div>
    </div>
</div>

<!-- Estilos CSS para ajuste de layout -->



<!-- Scripts JavaScript -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $(document).ready(function() {
        // Inicializa Select2 nos campos especificados
        $('#id_medicamento, #id_lote, #id_departamento').select2();

        // Evento para desabilitar o botão de submit enquanto o formulário está sendo processado
        const form = document.querySelector('#saida-estoque-form');
        form.addEventListener('submit', function() {
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true; // Desabilita o botão
            submitButton.textContent = 'Processando...'; // Atualiza texto do botão
        });

        // Adiciona evento ao campo medicamento para atualizar lotes ao mudar
        $('#id_medicamento').on('change', function() {
            const medicamentoId = $(this).val();
            const loteSelect = $('#id_lote');

            // Faz a requisição para obter os lotes correspondentes ao medicamento
            $.ajax({
                url: `/estoque/api/lotes_por_medicamento/${medicamentoId}/`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    // Limpa as opções anteriores de lote
                    loteSelect.empty();
                    loteSelect.append(new Option("Selecione um lote", ""));
                    
                    // Itera sobre os lotes retornados e adiciona ao select
                    data.lotes.forEach(function(lote) {
                        const option = $('<option></option>').val(lote.id).text(`${lote.lote} - ${lote.quantidade} unidades`);
                        loteSelect.append(option);
                    });

                    // Atualiza o Select2
                    loteSelect.trigger('change');
                },
                error: function(xhr, status, error) {
                    console.error('Erro ao buscar lotes:', error);
                }
            });
        });
    });
</script>
{% endblock %}
