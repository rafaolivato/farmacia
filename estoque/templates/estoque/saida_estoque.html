{% extends 'estoque/base.html' %}

{% block title %}Saída de Medicamento{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">Saída de Medicamento</h2>
    <form method="post" novalidate>
        {% csrf_token %}
        {{ form.as_p }}
        <button type="button" class="btn btn-info" id="select-lote-btn">Selecionar Lote</button>
        <button type="submit" class="btn btn-primary">Salvar</button>
    </form>
</div>

<!-- Modal para selecionar lote -->
<div class="modal fade" id="selectLoteModal" tabindex="-1" aria-labelledby="selectLoteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="selectLoteModalLabel">Selecionar Lote</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <select id="lote-select" class="form-control select2">
                    <!-- Lotes serão carregados dinamicamente via AJAX -->
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="confirmar-lote">Confirmar Lote</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // Inicializar Select2 nos campos existentes
        $('#id_medicamento, #id_departamento').select2();

        $('#select-lote-btn').on('click', function() {
            const medicamentoId = $('#id_medicamento').val();

            if (!medicamentoId) {
                alert('Por favor, selecione um medicamento primeiro.');
                return;
            }

            // Faz a requisição AJAX para buscar os lotes
            $.ajax({
                url: `/api/lotes_por_medicamento/`, // Chama a URL da API
                type: 'GET',
                data: {
                    medicamento_id: medicamentoId
                },
                success: function(data) {
                    const loteSelect = $('#lote-select');
                    loteSelect.empty(); // Limpa o select

                    // Preenche o select com os lotes retornados
                    data.lotes.forEach(function(lote) {
                        const option = $('<option></option>').val(lote.id).text(lote.lote);
                        loteSelect.append(option);
                    });

                    // Atualiza o Select2
                    loteSelect.trigger('change');

                    // Exibe o modal de seleção de lote
                    const selectLoteModal = new bootstrap.Modal(document.getElementById('selectLoteModal'));
                    selectLoteModal.show();
                },
                error: function(xhr, status, error) {
                    console.error('Erro ao buscar lotes:', error);
                }
            });
        });

        $('#confirmar-lote').on('click', function() {
            const selectedLote = $('#lote-select').val();
            $('#id_lote').val(selectedLote).trigger('change');
            $('#selectLoteModal').modal('hide');
        });
    });
</script>
{% endblock %}