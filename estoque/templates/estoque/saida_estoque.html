{% extends 'estoque/base.html' %}

{% block content %}
<div class="container mt-5">
    <div class="card shadow-lg">
        <div class="card-header bg-primary text-white text-center">
            <h2 class="logincolor">Saída de Estoque</h2>
        </div>
        <div class="card-body">
            <!-- Formulário para a saída de estoque -->
            <form method="POST" id="saida-estoque-form">
                {% csrf_token %}
                <div id="medicamento-container">
                {{ form.as_p }}
                </div>
                <!-- Botão para confirmar a retirada -->
                <button type="submit" class="btn btn-primary mt-4">Confirmar Retirada</button>
                <button type="button" class="btn btn-success" id="add-medicamento-btn">Adicionar Medicamentos</button>

            </form>
        </div>
    </div>
</div>

<!-- Estilos CSS para ajuste de layout -->



<!-- Scripts JavaScript -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $(document).ready(function() {
        $('#id_medicamento, #id_lote, #id_departamento').select2();
        
        let medicamentoIndex = 0;

        $('#id_medicamento').on('change', function() {
            const medicamentoId = $(this).val();
            const loteSelect = $('#id_lote');
            $.ajax({
                url: `/estoque/api/lotes_por_medicamento/${medicamentoId}/`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    loteSelect.empty();
                    loteSelect.append(new Option("Selecione um lote", ""));
                    data.lotes.forEach(function(lote) {
                        const option = $('<option></option>').val(lote.id).text(`${lote.lote} - ${lote.quantidade} unidades`);
                        loteSelect.append(option);
                    });
                    loteSelect.trigger('change');
                },
                error: function(xhr, status, error) {
                    console.error('Erro ao buscar lotes:', error);
                }
            });
        });

        $('#add-medicamento-btn').click(function() {
            medicamentoIndex++;
            const medicamentoContainer = $('#medicamento-container');
            const newEntry = `
                <div class="medicamento-entry">
                    <div class="form-group">
                        <label for="id_medicamento_${medicamentoIndex}">Medicamento</label>
                        <select id="id_medicamento_${medicamentoIndex}" name="medicamento_${medicamentoIndex}" class="form-control select2">
                            ${$('#id_medicamento').html()}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="id_quantidade_${medicamentoIndex}">Quantidade</label>
                        <input type="number" id="id_quantidade_${medicamentoIndex}" name="quantidade_${medicamentoIndex}" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="id_lote_${medicamentoIndex}">Lote</label>
                        <select id="id_lote_${medicamentoIndex}" name="lote_${medicamentoIndex}" class="form-control select2">
                            ${$('#id_lote').html()}
                        </select>
                    </div>
                </div>
            `;
            medicamentoContainer.append(newEntry);
            $('.select2').select2(); 
        });

        const form = document.querySelector('#saida-estoque-form');
        form.addEventListener('submit', function() {
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Processando...';
        });
    });
</script>


{% endblock %}
